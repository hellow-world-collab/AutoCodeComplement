# AI 代码补全插件使用说明

## 功能简介

本插件为 PyCharm 2019.3.5 社区版提供了两个基于大语言模型的功能：

### 1. 智能代码补全（Shift + Alt + A）
- **开启/关闭**：按 `Shift + Alt + A` 切换 AI 代码补全功能
- **自动触发**：当功能开启时，在输入代码时会自动触发 AI 补全
- **显示建议**：补全建议以灰色文字显示在光标位置
- **接受建议**：按 `Tab` 键接受当前的补全建议

### 2. 代码分析与优化（Shift + Alt + 1 / 2）
- **分析代码**：选中一段代码，按 `Shift + Alt + 1` 发送给 AI 分析和优化
- **查看差异**：AI 会返回优化建议，并在模态对话框中显示差异对比
- **锁定编辑**：差异窗口打开时，原代码编辑器自动锁定，防止误编辑
- **应用修改**：在对话框中点击“应用修改”或按 `Shift + Alt + 2`
- **放弃修改**：点击“取消”按钮，编辑器恢复可编辑状态

### 3. 代码注释功能（Shift + Alt + 3）
- **添加注释**：选中一段代码，按 `Shift + Alt + 3`
- **AI 分析**：AI 会理解代码上下文，为代码添加专业注释
- **差异对比**：同样在模态对话框中显示添加注释后的效果
- **应用/取消**：与代码优化功能相同的操作方式

## 快捷键汇总

| 快捷键               | 功能 |
|-------------------|------|
| `Shift + Alt + A` | 开启/关闭 AI 代码补全 |
| `Tab`             | 接受代码补全建议 |
| `Shift + Alt + 1` | 将选中代码发送给 AI 分析和优化 |
| `Shift + Alt + 3` | 为选中代码添加专业注释 |
| `Shift + Alt + 2` | 应用 AI 的修改建议 |

## 配置说明

### 首次使用配置

1. 打开 PyCharm，进入 `File` -> `Settings` -> `AI Code Completion`
2. 配置以下选项：
   - **API URL**：大模型 API 地址（默认：OpenAI API）
   - **API Key**：你的 API 密钥（必填）
   - **Model**：使用的模型名称（默认：gpt-4o-mini）
   - **触发延迟**：输入后多久触发补全（默认：500ms）
   - **最大建议长度**：补全建议的最大字符数（默认：150）

3. 点击 `Apply` 保存设置

### 支持的 API

本插件支持所有兼容 OpenAI Chat Completions API 格式的服务，包括：
- OpenAI GPT 系列
- 其他兼容 OpenAI API 格式的服务（如 Azure OpenAI、本地部署的大模型等）

只需将 API URL 和 API Key 配置为对应服务的地址和密钥即可。

## 使用示例

### 示例 1：代码补全

```python
# 输入以下代码：
def calculate_sum(a, b):
    # 按下 Shift+Alt+A 开启补全
    # 输入 "return "，等待 AI 建议
    # 看到灰色提示 "a + b" 后按 Tab 接受
    return a + b
```

### 示例 2：代码优化

```python
# 选中以下代码：
result = []
for i in range(10):
    result.append(i * 2)

# 按 Shift+Alt+1 发送给 AI 分析
# AI 可能建议改为：
result = [i * 2 for i in range(10)]

# 在模态对话框中查看差异对比（此时原编辑器自动锁定）
# 点击“应用修改”或按 Shift+Alt+2 应用
# 点击“取消”放弃修改，编辑器恢复可编辑状态
```

### 示例 3：添加注释

```python
# 选中以下代码：
def process_data(data):
    filtered = [x for x in data if x > 0]
    return sum(filtered) / len(filtered)

# 按 Shift+Alt+3 发送给 AI
# AI 会添加专业注释：
def process_data(data):
    """
    计算数据中正数的平均值
    
    Args:
        data: 数值列表
    
    Returns:
        float: 正数的平均值
    """
    # 过滤出所有正数
    filtered = [x for x in data if x > 0]
    # 计算平均值
    return sum(filtered) / len(filtered)

# 在对话框中查看对比，确认后应用
```

## 注意事项

1. **网络要求**：需要能够访问配置的 API 地址
2. **代理设置**：插件默认使用 HTTP 代理 127.0.0.1:7897
   - 如果不需要代理，需在 `LLMClient.java` 中注释掉代理配置
   - 如需修改代理地址，请编辑 `createHttpClient()` 方法
3. **API 费用**：使用过程中会调用 API，可能产生费用
   - 插件内置智能缓存机制，可减少重复调用
4. **延迟设置**：如果补全触发太频繁，可以增加触发延迟时间
5. **建议质量**：建议质量取决于所使用的模型和上下文内容
6. **模态对话框**：查看差异时编辑器会被锁定，防止误操作

## 故障排查

### 补全不工作
1. 检查是否按 `Shift+Alt+A` 开启了补全功能
2. 检查 API Key 是否配置正确
3. 检查网络连接是否正常
4. 查看 IDE 日志中是否有错误信息

### 差异窗口不显示
1. 确保选中了代码再按 `Shift+Alt+1` 或 `Shift+Alt+3`
2. 检查 API 是否返回了有效结果
3. 等待 AI 分析完成（可能需要几秒钟）
4. 检查网络连接和代理设置

### 编辑器被锁定无法编辑
1. 这是正常行为，防止在查看差异时误编辑代码
2. 关闭差异对话框后编辑器会自动恢复可编辑状态
3. 如果对话框关闭后仍被锁定，请重启 IDE

### 缓存相关问题
1. 插件使用 60 秒缓存，相同上下文不会重复调用 API
2. 如需清空缓存，请重启 IDE
3. 缓存最多保存 100 条记录，采用 LRU 策略



## 开发信息

- **插件 ID**：com.system.demo
- **适用版本**：PyCharm Community Edition 2019.3.5
- **开发语言**：Java
- **依赖库**：OkHttp、org.json

## 许可证

本插件仅供学习和个人使用。
